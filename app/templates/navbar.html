<!-- Top Bar -->
<div class="topbar">
    <div class="topbar-left">
        <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleSidebar()">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <a href="{{ url_for('main.dashboard') }}" class="topbar-brand">
            <span class="logo-icon">üåê</span>
            <span>LAN Monitor</span>
        </a>
    </div>
    <div class="topbar-right">
        <!-- Dropdown alert√≥w -->
        <div class="topbar-alerts">
            <button class="alerts-toggle" onclick="toggleAlertsDropdown()">
                üîî
                {% set unread_count = get_unread_alerts_count() %}
                {% if unread_count and unread_count > 0 %}
                    <span class="alerts-badge">{{ unread_count }}</span>
                {% endif %}
            </button>
            <div id="alerts-dropdown-top" class="alerts-dropdown-menu">
                <div class="alerts-dropdown-header">
                    <strong>Powiadomienia</strong>
                    {% if unread_count and unread_count > 0 %}
                        <a href="{{ url_for('main.mark_all_alerts_read') }}" class="mark-all-read" onclick="clearHiddenAlerts()">Oznacz wszystkie jako przeczytane</a>
                    {% endif %}
                </div>
                <div class="alerts-dropdown-content" id="alerts-list">
                    <div class="alerts-loading">≈Åadowanie...</div>
                </div>
                <div class="alerts-dropdown-footer">
                    <a href="{{ url_for('main.alerts_page', period='all') }}">Zobacz wszystkie alerty ‚Üí</a>
                </div>
            </div>
        </div>
        
        <!-- Dropdown u≈ºytkownika -->
        <div class="topbar-user">
            <button class="dropdown-toggle user-dropdown-toggle" onclick="toggleUserDropdown()">
                üë§ {{ current_user.username }}
                <span class="dropdown-arrow">‚ñº</span>
            </button>
            <div id="user-dropdown" class="dropdown-menu dropdown-menu-right">
                <a href="{{ url_for('auth.change_password') }}" class="dropdown-item">
                    üîë Zmie≈Ñ has≈Ço
                </a>
                <div class="dropdown-divider"></div>
                <a href="{{ url_for('auth.logout') }}" class="dropdown-item">
                    üö™ Wyloguj
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Overlay -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <nav class="sidebar-nav">
        <a href="{{ url_for('main.all_devices') }}" class="sidebar-link">
            <span class="sidebar-link-icon">üìÑ</span>
            <span class="sidebar-link-text">Raporty</span>
        </a>
        
        <div class="sidebar-section">
            <a href="#" class="sidebar-link has-dropdown" onclick="toggleSidebarDropdown('alerts-dropdown'); return false;">
                <span class="sidebar-link-icon">üîî</span>
                <span class="sidebar-link-text">Alerty</span>
                {% set unread_count = get_unread_alerts_count() %}
                {% if unread_count and unread_count > 0 %}
                    <span class="sidebar-badge">{{ unread_count }}</span>
                {% endif %}
                <span class="sidebar-arrow">‚ñº</span>
            </a>
            <div id="alerts-dropdown" class="sidebar-dropdown">
                <a href="{{ url_for('main.alerts_page', period='1') }}" class="sidebar-dropdown-link">Ostatnia godzina</a>
                <a href="{{ url_for('main.alerts_page', period='24') }}" class="sidebar-dropdown-link">Ostatnie 24h</a>
                <a href="{{ url_for('main.alerts_page', period='168') }}" class="sidebar-dropdown-link">Ostatni tydzie≈Ñ</a>
                <a href="{{ url_for('main.alerts_page', period='all') }}" class="sidebar-dropdown-link">Wszystkie</a>
            </div>
        </div>
        
        <a href="{{ url_for('main.email_settings') }}" class="sidebar-link">
            <span class="sidebar-link-icon">üìß</span>
            <span class="sidebar-link-text">Powiadomienia email</span>
        </a>
    </nav>
</div>


<script>
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const hamburger = document.getElementById('hamburgerBtn');
        
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
        hamburger.classList.toggle('active');
    }
    
    function closeSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const hamburger = document.getElementById('hamburgerBtn');
        
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
        hamburger.classList.remove('active');
    }
    
    function toggleSidebarDropdown(id) {
        const dropdown = document.getElementById(id);
        const allDropdowns = document.querySelectorAll('.sidebar-dropdown');
        const allArrows = document.querySelectorAll('.sidebar-arrow');
        
        // Znajd≈∫ strza≈Çkƒô nale≈ºƒÖcƒÖ do tego dropdown
        const parentLink = dropdown.previousElementSibling;
        const arrow = parentLink ? parentLink.querySelector('.sidebar-arrow') : null;
        
        // Zamknij wszystkie inne dropdowny i zresetuj ich strza≈Çki
        allDropdowns.forEach((d, index) => {
            if (d.id !== id) {
                d.classList.remove('active');
                if (allArrows[index]) {
                    allArrows[index].classList.remove('rotated');
                }
            }
        });
        
        // Toggle aktualnego dropdown
        dropdown.classList.toggle('active');
        
        // Toggle strza≈Çki
        if (arrow) {
            arrow.classList.toggle('rotated');
        }
    }
    
    function toggleUserDropdown() {
        const dropdown = document.getElementById('user-dropdown');
        const arrow = document.querySelector('.user-dropdown-toggle .dropdown-arrow');
        
        dropdown.classList.toggle('show');
        if (arrow) {
            arrow.classList.toggle('rotated');
        }
    }
    
    function toggleAlertsDropdown() {
        const dropdown = document.getElementById('alerts-dropdown-top');
        dropdown.classList.toggle('show');
        
        // Za≈Çaduj alerty przy pierwszym otwarciu
        if (dropdown.classList.contains('show')) {
            loadAlerts();
        }
    }
    
    function loadAlerts() {
        fetch('{{ url_for("main.get_recent_alerts_api") }}')
            .then(response => response.json())
            .then(data => {
                const alertsList = document.getElementById('alerts-list');
                
                // Pobierz listƒô ukrytych alert√≥w z localStorage
                const hiddenAlerts = JSON.parse(localStorage.getItem('hiddenAlerts') || '[]');
                
                if (data.alerts && data.alerts.length > 0) {
                    // Filtruj alerty - nie pokazuj ukrytych
                    const visibleAlerts = data.alerts.filter(alert => !hiddenAlerts.includes(alert.id));
                    
                    if (visibleAlerts.length > 0) {
                        alertsList.innerHTML = visibleAlerts.map(alert => `
                            <div class="alert-item-wrapper ${alert.is_read ? '' : 'unread'}">
                                <a href="{{ url_for('main.alerts_page', period='all') }}?alert_id=${alert.id}" 
                                   class="alert-item-link"
                                   onclick="markAlertRead(${alert.id})">
                                    <div class="alert-item-icon">${alert.icon}</div>
                                    <div class="alert-item-content">
                                        <div class="alert-item-title">${alert.alert_type}</div>
                                        <div class="alert-item-message">${alert.message}</div>
                                        <div class="alert-item-time">${alert.time}</div>
                                    </div>
                                </a>
                                <button class="alert-item-delete" onclick="deleteAlertFromDropdown(event, ${alert.id})" title="Usu≈Ñ z listy">
                                    ‚úï
                                </button>
                            </div>
                        `).join('');
                    } else {
                        alertsList.innerHTML = '<div class="alerts-empty">Brak nowych alert√≥w</div>';
                    }
                } else {
                    alertsList.innerHTML = '<div class="alerts-empty">Brak nowych alert√≥w</div>';
                }
            })
            .catch(error => {
                console.error('B≈ÇƒÖd ≈Çadowania alert√≥w:', error);
                document.getElementById('alerts-list').innerHTML = '<div class="alerts-empty">B≈ÇƒÖd ≈Çadowania alert√≥w</div>';
            });
    }
    
    function deleteAlertFromDropdown(event, alertId) {
        event.preventDefault();
        event.stopPropagation();
        
        // Dodaj do listy ukrytych alert√≥w w localStorage
        const hiddenAlerts = JSON.parse(localStorage.getItem('hiddenAlerts') || '[]');
        if (!hiddenAlerts.includes(alertId)) {
            hiddenAlerts.push(alertId);
            localStorage.setItem('hiddenAlerts', JSON.stringify(hiddenAlerts));
        }
        
        // Usu≈Ñ wizualnie z dropdownu
        const alertWrapper = event.target.closest('.alert-item-wrapper');
        alertWrapper.style.opacity = '0';
        alertWrapper.style.transform = 'translateX(20px)';
        
        setTimeout(() => {
            alertWrapper.remove();
            
            // Sprawd≈∫ czy sƒÖ jeszcze jakie≈õ alerty
            const alertsList = document.getElementById('alerts-list');
            if (alertsList.querySelectorAll('.alert-item-wrapper').length === 0) {
                alertsList.innerHTML = '<div class="alerts-empty">Brak nowych alert√≥w</div>';
            }
        }, 200);
        
        // Oznacz jako przeczytany (≈ºeby zniknƒÖ≈Ç z licznika)
        fetch(`{{ url_for('main.mark_alert_read', alert_id=0) }}`.replace('0', alertId), {
            method: 'POST',
        }).catch(error => console.error('B≈ÇƒÖd oznaczania alertu:', error));
    }
    
    function markAlertRead(alertId) {
        fetch(`{{ url_for('main.mark_alert_read', alert_id=0) }}`.replace('0', alertId), {
            method: 'POST',
        }).catch(error => console.error('B≈ÇƒÖd oznaczania alertu:', error));
    }
    
    function clearHiddenAlerts() {
        // Wyczy≈õƒá listƒô ukrytych alert√≥w z localStorage
        localStorage.removeItem('hiddenAlerts');
    }
    
    // Zamknij dropdowny przy klikniƒôciu poza nimi
    document.addEventListener('click', function(event) {
        const alertsDropdown = document.getElementById('alerts-dropdown-top');
        const alertsToggle = document.querySelector('.alerts-toggle');
        const userDropdown = document.getElementById('user-dropdown');
        const userToggle = document.querySelector('.user-dropdown-toggle');
        
        if (alertsDropdown && !alertsDropdown.contains(event.target) && !alertsToggle.contains(event.target)) {
            alertsDropdown.classList.remove('show');
        }
        
        if (userDropdown && !userDropdown.contains(event.target) && !userToggle.contains(event.target)) {
            userDropdown.classList.remove('show');
        }
    });
    
    // Zamknij sidebar po klikniƒôciu w link
    document.querySelectorAll('.sidebar-link:not(.has-dropdown), .sidebar-dropdown-link').forEach(link => {
        link.addEventListener('click', closeSidebar);
    });
</script>
