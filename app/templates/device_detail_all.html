<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ device.ip_address }} - Raporty</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="dashboard">
    {% include 'navbar.html' %}

    <div class="page-header">
        <div class="page-header-content">
            <a href="{{ url_for('main.all_devices') }}" class="btn btn-secondary btn-small">â† Wszystkie urzÄ…dzenia</a>
            <h1>ğŸ“Š {{ device.ip_address }} - Raporty</h1>
            <div style="width: 150px;"></div>
        </div>
    </div>
    
    <div class="container">
        <!-- Podstawowe informacje o urzÄ…dzeniu -->
        <div class="device-info-card">
            <h2>ğŸ’» Informacje o urzÄ…dzeniu</h2>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Adres IP</span>
                    <span class="info-value">{{ device.ip_address }}</span>
                </div>
                {% if device.mac_address %}
                <div class="info-item">
                    <span class="info-label">Adres MAC</span>
                    <span class="info-value">{{ device.mac_address }}</span>
                </div>
                {% endif %}
                <div class="info-item">
                    <span class="info-label">Dostawca</span>
                    <span class="info-value">{{ device.vendor or 'Nieznany' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Status</span>
                    <span class="status-badge {{ 'status-active' if device.is_online else 'status-inactive' }}">
                        {{ 'ğŸŸ¢ Online' if device.is_online else 'ğŸ”´ Offline' }}
                    </span>
                </div>
                {% if device.last_seen %}
                <div class="info-item">
                    <span class="info-label">Ostatnia aktywnoÅ›Ä‡</span>
                    <span class="info-value">{{ device.last_seen.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Layout dwukolumnowy -->
        <div class="reports-layout">
            <!-- Lewa kolumna: Generator raportÃ³w -->
            <div class="reports-generator">
                <div class="reports-section-header">
                    <div class="section-icon">ğŸ“Š</div>
                    <div>
                        <h2>Generowanie raportÃ³w</h2>
                        <p>Wybierz okres i wygeneruj raport</p>
                    </div>
                </div>
                
                <div class="generator-form">
                    <div class="form-group">
                        <label for="reportPeriod">Okres raportu</label>
                        <select id="reportPeriod" class="form-select">
                            <option value="1">ğŸ“… Raport dzienny (24h)</option>
                            <option value="7" selected>ğŸ“Š Raport tygodniowy (7 dni)</option>
                            <option value="30">ğŸ“ˆ Raport miesiÄ™czny (30 dni)</option>
                        </select>
                    </div>
                    
                    <div class="action-buttons-grid">
                        <button onclick="generateReport()" class="btn-action btn-primary-action">
                            <span class="btn-icon">ğŸŒ</span>
                            <div>
                                <div class="btn-title">Generuj HTML</div>
                                <div class="btn-subtitle">OtwÃ³rz w przeglÄ…darce</div>
                            </div>
                        </button>
                        
                        <button onclick="generateReportPDF()" class="btn-action btn-secondary-action">
                            <span class="btn-icon">ğŸ“„</span>
                            <div>
                                <div class="btn-title">Pobierz PDF</div>
                                <div class="btn-subtitle">Zapisz na dysku</div>
                            </div>
                        </button>
                    </div>
                    
                    <div class="form-group email-section">
                        <label class="checkbox-label">
                            <input type="checkbox" id="sendEmailCheckbox" onchange="toggleEmailSelect()">
                            <span>WyÅ›lij raport emailem</span>
                        </label>
                    </div>
                    
                    <div id="emailSelectGroup" class="form-group" style="display: none;">
                        <label for="emailRecipient">Wybierz odbiorcÄ™</label>
                        <select id="emailRecipient" class="form-select">
                            <option value="">-- Wybierz email --</option>
                            {% if email_recipients %}
                                {% for recipient in email_recipients %}
                                <option value="{{ recipient.email }}">{{ recipient.email }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                        
                        <button onclick="sendReportEmail(this)" class="btn-send-email">
                            <span>âœ‰ï¸</span>
                            WyÅ›lij raport
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Prawa kolumna: Lista wygenerowanych raportÃ³w -->
            <div class="reports-history">
                <div class="reports-section-header">
                    <div class="section-icon">ğŸ“‹</div>
                    <div>
                        <h2>Historia raportÃ³w</h2>
                        <p>Ostatnio wygenerowane raporty</p>
                    </div>
                </div>
                
                <div class="reports-list">
                    {% if reports %}
                        {% for report in reports %}
                        <div class="report-item">
                            <div class="report-icon">
                                {% if report.period_days == 1 %}ğŸ“…
                                {% elif report.period_days == 7 %}ğŸ“Š
                                {% else %}ğŸ“ˆ{% endif %}
                            </div>
                            <div class="report-info">
                                <div class="report-title">Raport {{ report.period_name }}</div>
                                <div class="report-date">{{ report.generated_at.strftime('%Y-%m-%d %H:%M') }}</div>
                            </div>
                            <div class="report-actions">
                                <button onclick="viewReport({{ report.id }}, {{ report.period_days }})" 
                                        class="btn-icon-action" title="Zobacz raport">
                                    ğŸ‘ï¸
                                </button>
                                <button onclick="downloadReportPDF({{ report.period_days }})" 
                                        class="btn-icon-action" title="Pobierz PDF">
                                    ğŸ“¥
                                </button>
                                <button onclick="showEmailModal({{ report.id }})" 
                                        class="btn-icon-action" title="WyÅ›lij emailem">
                                    ğŸ“§
                                </button>
                                <button onclick="deleteReport({{ report.id }})" 
                                        class="btn-icon-action btn-delete" title="UsuÅ„ raport">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“­</div>
                            <p>Brak wygenerowanych raportÃ³w</p>
                            <small>Wygeneruj pierwszy raport uÅ¼ywajÄ…c formularza obok</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Modal do wysyÅ‚ania emaila -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“§ WyÅ›lij raport emailem</h3>
                <button class="modal-close" onclick="closeEmailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="emailInput">Adres email odbiorcy</label>
                    <input type="email" id="emailInput" class="form-control" 
                           placeholder="np. osoba@example.com" required>
                </div>
                <div id="emailError" class="error-message" style="display: none;"></div>
                <div id="emailSuccess" class="success-message" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button onclick="closeEmailModal()" class="btn btn-secondary">Anuluj</button>
                <button onclick="sendExistingReportEmail()" class="btn btn-primary">
                    <span>ğŸ“¤</span> WyÅ›lij
                </button>
            </div>
        </div>
    </div>

    <script>
        const deviceId = {{ device.id }};
        let currentReportId = null;

        function toggleEmailSelect() {
            const checkbox = document.getElementById('sendEmailCheckbox');
            const emailGroup = document.getElementById('emailSelectGroup');
            
            console.log('Checkbox checked:', checkbox.checked);
            console.log('Email group element:', emailGroup);
            
            if (checkbox.checked) {
                emailGroup.style.display = 'block';
            } else {
                emailGroup.style.display = 'none';
            }
        }

        function generateReport() {
            const period = document.getElementById('reportPeriod').value;
            
            let url = `/device/${deviceId}/generate-report?period=${period}&format=html`;
            
            fetch(url, {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.open(`/device/${deviceId}/report?period=${period}`, '_blank');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        alert('BÅ‚Ä…d: ' + (data.error || 'Nie udaÅ‚o siÄ™ wygenerowaÄ‡ raportu'));
                    }
                })
                .catch(error => {
                    alert('BÅ‚Ä…d poÅ‚Ä…czenia: ' + error);
                });
        }

        function generateReportPDF() {
            const period = document.getElementById('reportPeriod').value;
            
            let url = `/device/${deviceId}/generate-report?period=${period}&format=pdf`;
            
            fetch(url, {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = `/device/${deviceId}/report/pdf?period=${period}`;
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        alert('BÅ‚Ä…d: ' + (data.error || 'Nie udaÅ‚o siÄ™ wygenerowaÄ‡ raportu'));
                    }
                })
                .catch(error => {
                    alert('BÅ‚Ä…d poÅ‚Ä…czenia: ' + error);
                });
        }

        function sendReportEmail(btn) {
            const period = document.getElementById('reportPeriod').value;
            const emailRecipient = document.getElementById('emailRecipient').value;
            
            if (!emailRecipient) {
                alert('Wybierz odbiorcÄ™ email!');
                return;
            }
            
            // PokaÅ¼ komunikat Å‚adowania
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span>â³</span> WysyÅ‚anie...';
            
            let url = `/device/${deviceId}/generate-report?period=${period}&format=pdf&email=${encodeURIComponent(emailRecipient)}`;
            
            fetch(url, {method: 'POST'})
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    
                    console.log('Response data:', data);
                    
                    if (data.success) {
                        if (data.email_sent === true) {
                            alert('âœ… Raport zostaÅ‚ pomyÅ›lnie wygenerowany i wysÅ‚any na email:\n' + emailRecipient);
                        } else if (data.email_sent === false && data.email_error) {
                            alert('âš ï¸ Raport zostaÅ‚ wygenerowany, ale wystÄ…piÅ‚ bÅ‚Ä…d podczas wysyÅ‚ania emaila:\n' + data.email_error);
                        } else {
                            alert('âœ… Raport zostaÅ‚ wygenerowany');
                        }
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        alert('âŒ BÅ‚Ä…d: ' + (data.error || 'Nie udaÅ‚o siÄ™ wysÅ‚aÄ‡ raportu'));
                    }
                })
                .catch(error => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    console.error('Fetch error:', error);
                    alert('âŒ BÅ‚Ä…d poÅ‚Ä…czenia: ' + error.message);
                });
        }

        function viewReport(reportId, period) {
            window.open(`/device/${deviceId}/report?period=${period}`, '_blank');
        }

        function downloadReportPDF(period) {
            window.location.href = `/device/${deviceId}/report/pdf?period=${period}`;
        }

        function showEmailModal(reportId) {
            currentReportId = reportId;
            document.getElementById('emailModal').style.display = 'flex';
            document.getElementById('emailInput').value = '';
            document.getElementById('emailError').style.display = 'none';
            document.getElementById('emailSuccess').style.display = 'none';
        }

        function closeEmailModal() {
            document.getElementById('emailModal').style.display = 'none';
            currentReportId = null;
        }

        function sendExistingReportEmail() {
            const email = document.getElementById('emailInput').value;
            const errorDiv = document.getElementById('emailError');
            const successDiv = document.getElementById('emailSuccess');
            
            if (!email) {
                errorDiv.textContent = 'ProszÄ™ podaÄ‡ adres email';
                errorDiv.style.display = 'block';
                return;
            }
            
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            // WyÅ›lij request
            fetch(`/device/${deviceId}/report/${currentReportId}/send-email`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `email=${encodeURIComponent(email)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    successDiv.textContent = data.message;
                    successDiv.style.display = 'block';
                    setTimeout(() => {
                        closeEmailModal();
                    }, 2000);
                } else {
                    errorDiv.textContent = data.error || 'WystÄ…piÅ‚ bÅ‚Ä…d';
                    errorDiv.style.display = 'block';
                }
            })
            .catch(error => {
                errorDiv.textContent = 'WystÄ…piÅ‚ bÅ‚Ä…d poÅ‚Ä…czenia';
                errorDiv.style.display = 'block';
            });
        }

        // Zamknij modal po klikniÄ™ciu poza nim
        window.onclick = function(event) {
            const modal = document.getElementById('emailModal');
            if (event.target == modal) {
                closeEmailModal();
            }
        }

        function deleteReport(reportId) {
            if (!confirm('Czy na pewno chcesz usunÄ…Ä‡ ten raport z historii?')) {
                return;
            }

            fetch(`/device/${deviceId}/report/${reportId}/delete`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('BÅ‚Ä…d: ' + (data.error || 'Nie udaÅ‚o siÄ™ usunÄ…Ä‡ raportu'));
                }
            })
            .catch(error => {
                alert('BÅ‚Ä…d poÅ‚Ä…czenia: ' + error);
            });
        }
    </script>
</body>
</html>
