<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - LAN Monitor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="dashboard">
    <!-- Navbar -->
    <nav class="navbar">
        <a href="{{ url_for('main.dashboard') }}" class="navbar-brand">üåê LAN Monitor</a>
        <div class="navbar-menu">
            <!-- Dropdown alert√≥w -->
            <div class="dropdown">
                <button class="dropdown-toggle" onclick="toggleDropdown('alerts-dropdown')">
                    ÔøΩ
                    {% if recent_alerts|length > 0 %}
                        <span class="notification-badge">{{ recent_alerts|length }}</span>
                    {% endif %}
                </button>
                <div id="alerts-dropdown" class="dropdown-menu">
                    <div class="dropdown-header">
                        <strong>Alerty</strong>
                    </div>
                    {% if recent_alerts %}
                        {% for alert in recent_alerts[:5] %}
                            <div class="dropdown-item alert-dropdown-item">
                                <div class="alert-dropdown-icon">
                                    {% if alert.severity == 'critical' %}‚ö†Ô∏è
                                    {% elif alert.severity == 'warning' %}‚ö°
                                    {% else %}‚ÑπÔ∏è{% endif %}
                                </div>
                                <div class="alert-dropdown-content">
                                    <strong>{{ alert.alert_type }}</strong>
                                    <p>{{ alert.message[:50] }}...</p>
                                    <small>{{ alert.created_at.strftime('%H:%M') }}</small>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="dropdown-item-empty">
                            Brak nowych alert√≥w
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Dropdown u≈ºytkownika -->
            <div class="dropdown">
                <button class="dropdown-toggle user-dropdown-toggle" onclick="toggleDropdown('user-dropdown')">
                    ÔøΩüë§ {{ current_user.username }}
                    <span class="dropdown-arrow">‚ñº</span>
                </button>
                <div id="user-dropdown" class="dropdown-menu dropdown-menu-right">
                    <div class="dropdown-header">
                        <strong>{{ current_user.username }}</strong>
                    </div>
                    <a href="{{ url_for('auth.change_password') }}" class="dropdown-item">
                        üîë Zmie≈Ñ has≈Ço
                    </a>
                    <div class="dropdown-divider"></div>
                    <a href="{{ url_for('auth.logout') }}" class="dropdown-item">
                        üö™ Wyloguj
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Komunikaty Flash -->
    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Statystyki -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-info">
                    <h3>{{ total_devices }}</h3>
                    <p>Wszystkie urzƒÖdzenia</p>
                </div>
            </div>
            
            <div class="stat-card stat-success">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-info">
                    <h3>{{ online_devices }}</h3>
                    <p>Online</p>
                </div>
            </div>
            
            <div class="stat-card stat-warning">
                <div class="stat-icon">üÜï</div>
                <div class="stat-info">
                    <h3>{{ new_devices }}</h3>
                    <p>Nowe urzƒÖdzenia</p>
                </div>
            </div>
            
            <div class="stat-card stat-info">
                <div class="stat-icon">üîî</div>
                <div class="stat-info">
                    <h3>{{ recent_alerts|length }}</h3>
                    <p>Alerty</p>
                </div>
            </div>
        </div>

        <!-- Lista urzƒÖdze≈Ñ -->
        <div class="content-section">
            <div class="section-header">
                <div class="section-header-content">
                    <h2>UrzƒÖdzenia w sieci</h2>
                    <a href="{{ url_for('main.scan_network') }}" class="btn btn-scan">
                        üîç Skanuj sieƒá
                    </a>
                </div>
            </div>
            
            {% if devices %}
                <div class="devices-grid">
                    {% for device in devices %}
                        <div class="device-card {% if not device.is_online %}offline{% endif %}">
                            <div class="device-header">
                                <div class="device-icon">
                                    {% if device.is_online %}üü¢{% else %}üî¥{% endif %}
                                    üíª
                                </div>
                                {% if device.is_new %}
                                    <span class="badge badge-new">NOWE</span>
                                {% endif %}
                            </div>
                            
                            <div class="device-info">
                                <h3>{{ device.hostname or 'Nieznane urzƒÖdzenie' }}</h3>
                                <p class="device-ip">IP: {{ device.ip_address or 'N/A' }}</p>
                                <p class="device-mac">MAC: {{ device.mac_address }}</p>
                                {% if device.vendor %}
                                    <p class="device-vendor">{{ device.vendor }}</p>
                                {% endif %}
                            </div>
                            
                            <div class="device-footer">
                                <small>Ostatnio widziane: {{ device.last_seen.strftime('%Y-%m-%d %H:%M') }}</small>
                                <a href="{{ url_for('main.device_detail', device_id=device.id) }}" class="btn-link">
                                    Szczeg√≥≈Çy ‚Üí
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">üì°</div>
                    <h3>Brak urzƒÖdze≈Ñ</h3>
                    <p>Nie wykryto jeszcze ≈ºadnych urzƒÖdze≈Ñ w sieci.</p>
                    <p>System skanowania rozpocznie pracƒô wkr√≥tce.</p>
                </div>
            {% endif %}
        </div>

        <!-- Ca≈Çkowity ruch sieciowy -->
        <div class="content-section">
            <div class="section-header">
                <h2>üìä Ca≈Çkowity ruch sieciowy</h2>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card stat-info">
                    <div class="stat-icon">‚¨áÔ∏è</div>
                    <div class="stat-info">
                        <h3>{{ (total_stats.total_bytes_in / 1048576) | round(2) }} MB</h3>
                        <p>Pobrano (aktualny okres)</p>
                    </div>
                </div>
                
                <div class="stat-card stat-success">
                    <div class="stat-icon">‚¨ÜÔ∏è</div>
                    <div class="stat-info">
                        <h3>{{ (total_stats.total_bytes_out / 1048576) | round(2) }} MB</h3>
                        <p>Wys≈Çano (aktualny okres)</p>
                    </div>
                </div>
                
                <div class="stat-card stat-warning">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-info">
                        <h3>{{ total_stats.total_packets_in + total_stats.total_packets_out }}</h3>
                        <p>Pakiety (razem)</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-info">
                        <h3>{{ total_stats.device_count }}</h3>
                        <p>Aktywne urzƒÖdzenia</p>
                    </div>
                </div>
            </div>
            
            <!-- Wykres z Grafany -->
            <div style="margin-top: 20px;">
                <iframe 
                    src="http://localhost:3000/d-solo/adptrmz/traffic-all-devices?orgId=1&refresh=30s&theme=dark&panelId=3&from=now-6h&to=now" 
                    width="100%" 
                    height="400" 
                    frameborder="0"
                    style="border-radius: 8px;">
                </iframe>
                <p style="text-align: center; margin-top: 10px; color: #666;">
                    üìä Wykres ca≈Çkowitego ruchu w czasie rzeczywistym (ostatnie 6h)
                </p>
            </div>
        </div>

        <!-- Alerty -->
        {% if recent_alerts %}
        <div class="content-section">
            <div class="section-header">
                <h2>Ostatnie alerty</h2>
            </div>
            
            <div class="alerts-list">
                {% for alert in recent_alerts %}
                    <div class="alert-item alert-{{ alert.severity }}">
                        <div class="alert-icon">
                            {% if alert.severity == 'critical' %}‚ö†Ô∏è
                            {% elif alert.severity == 'warning' %}‚ö°
                            {% else %}‚ÑπÔ∏è{% endif %}
                        </div>
                        <div class="alert-content">
                            <strong>{{ alert.alert_type }}</strong>
                            <p>{{ alert.message }}</p>
                            <small>{{ alert.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        // ≈öled≈∫ czy dropdown alert√≥w by≈Ç otwarty
        let alertsDropdownWasOpen = false;
        
        // Obs≈Çuga dropdown√≥w
        function toggleDropdown(id) {
            const dropdown = document.getElementById(id);
            const allDropdowns = document.querySelectorAll('.dropdown-menu');
            
            // Sprawd≈∫ czy dropdown alert√≥w jest otwierany
            const isAlertsDropdown = id === 'alerts-dropdown';
            const wasOpen = dropdown.classList.contains('show');
            
            // Zamknij wszystkie inne dropdowny
            allDropdowns.forEach(d => {
                if (d.id !== id) {
                    d.classList.remove('show');
                }
            });
            
            // Toggle aktualnego dropdowna
            dropdown.classList.toggle('show');
            
            // Je≈õli dropdown alert√≥w zosta≈Ç zamkniƒôty i by≈Ç otwarty, oznacz jako przeczytane
            if (isAlertsDropdown && wasOpen) {
                markAlertsAsRead();
            }
            
            // Zapamiƒôtaj stan dla alert√≥w
            if (isAlertsDropdown) {
                alertsDropdownWasOpen = dropdown.classList.contains('show');
            }
        }

        // Zamknij dropdown po klikniƒôciu poza nim
        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-toggle')) {
                const dropdowns = document.querySelectorAll('.dropdown-menu');
                const alertsDropdown = document.getElementById('alerts-dropdown');
                const wasAlertsOpen = alertsDropdown && alertsDropdown.classList.contains('show');
                
                dropdowns.forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
                
                // Je≈õli dropdown alert√≥w by≈Ç otwarty, oznacz jako przeczytane
                if (wasAlertsOpen) {
                    markAlertsAsRead();
                }
            }
        }
        
        // Funkcja do oznaczania alert√≥w jako przeczytanych
        function markAlertsAsRead() {
            fetch('{{ url_for("main.mark_alerts_read") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.marked_count > 0) {
                    console.log(`‚úÖ Oznaczono ${data.marked_count} alert√≥w jako przeczytane`);
                    // Od≈õwie≈º badge z liczbƒÖ alert√≥w
                    const badge = document.querySelector('.notification-badge');
                    if (badge) {
                        badge.style.display = 'none';
                    }
                    // Opcjonalnie: od≈õwie≈º kartƒô z liczbƒÖ alert√≥w
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('‚ùå B≈ÇƒÖd oznaczania alert√≥w:', error);
            });
        }
    </script>
</body>
</html>
