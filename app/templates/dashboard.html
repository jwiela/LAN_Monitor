<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - LAN Monitor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="dashboard">
    {% include 'navbar.html' %}

    <!-- Komunikaty Flash -->
    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Lista urzÄ…dzeÅ„ -->
        <div class="content-section">
            <div class="section-header">
                <div class="section-header-content">
                    <h2>ðŸ“± UrzÄ…dzenia w sieci</h2>
                    <a href="{{ url_for('main.scan_network') }}" class="btn btn-secondary">
                        Skanuj sieÄ‡
                    </a>
                </div>
            </div>
            
            {% if devices %}
                <div class="devices-table-container">
                    <table class="devices-table">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Nazwa</th>
                                <th>Adres IP</th>
                                <th>Adres MAC</th>
                                <th>Producent</th>
                                <th>Ostatnio widziane</th>
                                <th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for device in devices %}
                                <tr class="{% if not device.is_online %}device-offline{% endif %}">
                                    <td class="device-status">
                                        <span class="status-indicator {% if device.is_online %}status-online{% else %}status-offline{% endif %}">
                                            {% if device.is_online %}ðŸŸ¢{% else %}ðŸ”´{% endif %}
                                        </span>
                                    </td>
                                    <td class="device-name">
                                        <strong>{{ device.hostname or 'Nieznane urzÄ…dzenie' }}</strong>
                                    </td>
                                    <td class="device-ip">{{ device.ip_address or 'N/A' }}</td>
                                    <td class="device-mac">{{ device.mac_address }}</td>
                                    <td class="device-vendor">{{ device.vendor or '-' }}</td>
                                    <td class="device-time">{{ device.last_seen.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td class="device-actions">
                                        <a href="{{ url_for('main.device_detail', device_id=device.id) }}" class="btn btn-secondary btn-sm">
                                            SzczegÃ³Å‚y
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">ðŸ“¡</div>
                    <h3>Brak urzÄ…dzeÅ„</h3>
                    <p>Nie wykryto jeszcze Å¼adnych urzÄ…dzeÅ„ w sieci.</p>
                    <p class="text-muted">Uruchom skanowanie lub poczekaj na automatycznÄ… detekcjÄ™.</p>
                </div>
            {% endif %}
        </div>

        <!-- CaÅ‚kowity ruch sieciowy -->
        <div class="content-section">
            <div class="section-header">
                <h2>ðŸ“Š CaÅ‚kowity ruch sieciowy</h2>
            </div>
            
            <div class="traffic-stats-grid">
                <div class="traffic-stat-item">
                    <div class="traffic-stat-icon">ðŸ“¥</div>
                    <div class="traffic-stat-content">
                        <div class="traffic-stat-label">Pobieranie</div>
                        <div class="traffic-stat-value" id="total-download-rate">{{ "%.2f"|format(total_stats.download_rate) }} KB/s</div>
                    </div>
                </div>
                
                <div class="traffic-stat-item">
                    <div class="traffic-stat-icon">ðŸ“¤</div>
                    <div class="traffic-stat-content">
                        <div class="traffic-stat-label">WysyÅ‚anie</div>
                        <div class="traffic-stat-value" id="total-upload-rate">{{ "%.2f"|format(total_stats.upload_rate) }} KB/s</div>
                    </div>
                </div>
                
                <div class="traffic-stat-item">
                    <div class="traffic-stat-icon">ðŸ‘¥</div>
                    <div class="traffic-stat-content">
                        <div class="traffic-stat-label">Aktywne urzÄ…dzenia</div>
                        <div class="traffic-stat-value" id="total-device-count">{{ total_stats.device_count }}</div>
                    </div>
                </div>
            </div>
            
            <!-- Wykres z Grafany -->
            <div class="grafana-container">
                <iframe 
                    src="http://192.168.1.12:3000/d-solo/adptrmz/traffic-all-devices?orgId=1&from=now-24h&to=now&timezone=browser&panelId=panel-3&__feature.dashboardSceneSolo=true&refresh=30s" 
                    width="100%" 
                    height="300" 
                    frameborder="0">
                </iframe>
                <p class="grafana-caption">
                    Wykres caÅ‚kowitego ruchu w czasie rzeczywistym (ostatnie 24h)
                </p>
            </div>
        </div>
    </div>
    
    <script>
        // Funkcja odÅ›wieÅ¼ajÄ…ca caÅ‚kowite statystyki ruchu
        function updateTotalStats() {
            fetch('{{ url_for("main.total_stats_api") }}')
                .then(response => response.json())
                .then(data => {
                    // Aktualizuj prÄ™dkoÅ›Ä‡ pobierania
                    document.getElementById('total-download-rate').textContent = data.download_rate_formatted;
                    
                    // Aktualizuj prÄ™dkoÅ›Ä‡ wysyÅ‚ania
                    document.getElementById('total-upload-rate').textContent = data.upload_rate_formatted;
                    
                    // Aktualizuj liczbÄ™ aktywnych urzÄ…dzeÅ„
                    document.getElementById('total-device-count').textContent = data.device_count;
                })
                .catch(error => {
                    console.error('BÅ‚Ä…d pobierania statystyk:', error);
                });
        }
        
        // OdÅ›wieÅ¼aj statystyki co 2 sekundy (tak samo jak dla urzÄ…dzeÅ„)
        setInterval(updateTotalStats, 2000);
        
        // Pierwsze odÅ›wieÅ¼enie po zaÅ‚adowaniu strony
        setTimeout(updateTotalStats, 1000);
    </script>
</body>
</html>
