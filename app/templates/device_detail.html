<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ device.ip_address }} - LAN Monitor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="dashboard">
    {% include 'navbar.html' %}

    <div class="page-header">
        <div class="page-header-content">
            <a href="{{ back_url }}" class="btn btn-secondary btn-small">â† {{ back_text }}</a>
            <h1>ğŸ’» SzczegÃ³Å‚y urzÄ…dzenia: {{ device.ip_address }}</h1>
            <div style="width: 80px;"></div>
        </div>
    </div>
    <div class="container">
        <div class="device-header">
            <div class="device-info">
                <h2>{{ device.vendor or 'ğŸ–¥ï¸ Nieznane urzÄ…dzenie' }}</h2>
                <div class="device-details">
                    <span class="detail-item">
                        <strong>IP:</strong> {{ device.ip_address }}
                    </span>
                    {% if device.mac_address %}
                    <span class="detail-item">
                        <strong>MAC:</strong> {{ device.mac_address }}
                    </span>
                    {% endif %}
                    <span class="detail-item">
                        <strong>Status:</strong> 
                        <span class="status-badge {{ 'status-active' if device.is_online else 'status-inactive' }}">
                            {{ 'ğŸŸ¢ Online' if device.is_online else 'ğŸ”´ Offline' }}
                        </span>
                    </span>
                </div>
            </div>
        </div>

        <!-- Statystyki bieÅ¼Ä…ce -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“¥</div>
                <div class="stat-content">
                    <div class="stat-label">Pobieranie</div>
                    <div class="stat-value">{{ download_rate }}</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“¤</div>
                <div class="stat-content">
                    <div class="stat-label">WysyÅ‚anie</div>
                    <div class="stat-value">{{ upload_rate }}</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-content">
                    <div class="stat-label">CaÅ‚kowity ruch (24h)</div>
                    <div class="stat-value">{{ total_traffic }}</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">â±ï¸</div>
                <div class="stat-content">
                    <div class="stat-label">Ostatnia aktywnoÅ›Ä‡</div>
                    <div class="stat-value">{{ last_seen }}</div>
                </div>
            </div>
        </div>

        <!-- Wykresy Grafana -->
        {% if grafana_enabled %}
        <div class="grafana-section">
            <h3>ğŸ“ˆ Wykresy ruchu sieciowego (24h)</h3>
            <div class="grafana-embed">
                <iframe
                    src="{{ grafana_url }}/d-solo/adptrmz/traffic-all-devices?orgId=1&var-device_ip={{ device.ip_address }}&panelId=1&from=now-24h&to=now&refresh=30s"
                    width="100%"
                    height="400"
                    frameborder="0">
                </iframe>
            </div>
            <div class="grafana-embed">
                <iframe
                    src="{{ grafana_url }}/d-solo/adptrmz/traffic-all-devices?orgId=1&var-device_ip={{ device.ip_address }}&panelId=4&from=now-24h&to=now&refresh=30s"
                    width="100%"
                    height="400"
                    frameborder="0">
                </iframe>
            </div>
        </div>
        {% else %}
        <div class="info-box">
            <p>âš ï¸ Grafana nie jest wÅ‚Ä…czona. Aby zobaczyÄ‡ wykresy, skonfiguruj InfluxDB i GrafanÄ™ w pliku .env</p>
        </div>
        {% endif %}
    </div>

    <script>
        function toggleDropdown(id) {
            const dropdown = document.getElementById(id);
            dropdown.classList.toggle('show');
            
            // Zamknij inne dropdowny
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                if (menu.id !== id) {
                    menu.classList.remove('show');
                }
            });
        }

        // Zamknij dropdown po klikniÄ™ciu poza nim
        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-toggle')) {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        }

        // Real-time update statystyk
        const deviceId = {{ device.id }};
        
        function updateStats() {
            fetch(`/api/device/${deviceId}/stats`)
                .then(response => response.json())
                .then(data => {
                    console.log('API Response:', data);  // DEBUG
                    // Aktualizuj prÄ™dkoÅ›ci
                    const downloadElements = document.querySelectorAll('.stat-card:nth-child(1) .stat-value');
                    const uploadElements = document.querySelectorAll('.stat-card:nth-child(2) .stat-value');
                    const lastSeenElements = document.querySelectorAll('.stat-card:nth-child(4) .stat-value');
                    
                    if (downloadElements.length > 0) {
                        downloadElements[0].textContent = data.download_rate_formatted;
                        // Dodaj animacjÄ™ przy zmianie
                        downloadElements[0].style.color = data.download_rate > 0 ? '#667eea' : '#999';
                    }
                    
                    if (uploadElements.length > 0) {
                        uploadElements[0].textContent = data.upload_rate_formatted;
                        uploadElements[0].style.color = data.upload_rate > 0 ? '#667eea' : '#999';
                    }
                    
                    if (lastSeenElements.length > 0) {
                        lastSeenElements[0].textContent = data.last_seen;
                    }
                    
                    // Aktualizuj status badge
                    const statusBadge = document.querySelector('.status-badge');
                    if (statusBadge) {
                        if (data.status === 'online') {
                            statusBadge.className = 'status-badge status-active';
                            statusBadge.textContent = 'ğŸŸ¢ Online';
                        } else {
                            statusBadge.className = 'status-badge status-inactive';
                            statusBadge.textContent = 'ğŸ”´ Offline';
                        }
                    }
                    
                    // Dodaj nowÄ… aktywnoÅ›Ä‡ do tabeli jeÅ›li jest nowsza
                    if (data.latest_activity) {
                        const tbody = document.querySelector('.activity-table tbody');
                        const firstRow = tbody.querySelector('tr');
                        
                        // SprawdÅº czy to nowy wpis
                        if (firstRow && !firstRow.classList.contains('no-data')) {
                            const firstTimestamp = firstRow.querySelector('td:first-child').textContent;
                            if (firstTimestamp !== data.latest_activity.timestamp) {
                                // Dodaj nowy wiersz na gÃ³rze
                                const newRow = document.createElement('tr');
                                newRow.innerHTML = `
                                    <td>${data.latest_activity.timestamp}</td>
                                    <td>${(data.latest_activity.bytes_received / 1024 / 1024).toFixed(2)} MB</td>
                                    <td>${(data.latest_activity.bytes_sent / 1024 / 1024).toFixed(2)} MB</td>
                                    <td>${data.latest_activity.packets_received}</td>
                                    <td>${data.latest_activity.packets_sent}</td>
                                `;
                                newRow.style.backgroundColor = '#e8f5e9';
                                tbody.insertBefore(newRow, firstRow);
                                
                                // UsuÅ„ animacjÄ™ po 2 sekundach
                                setTimeout(() => {
                                    newRow.style.backgroundColor = '';
                                }, 2000);
                                
                                // Ogranicz do 100 wierszy
                                const rows = tbody.querySelectorAll('tr');
                                if (rows.length > 100) {
                                    rows[rows.length - 1].remove();
                                }
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('BÅ‚Ä…d podczas pobierania statystyk:', error);
                });
        }
        
        // Aktualizuj co 2 sekundy
        setInterval(updateStats, 2000);
        
        // Pierwsze wywoÅ‚anie po zaÅ‚adowaniu strony
        updateStats();
    </script>
</body>
</html>
